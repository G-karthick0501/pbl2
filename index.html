<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Interview Evaluator</title>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
</script>

<!-- compromise (tiny NLP, optional) -->
<script src="https://cdn.jsdelivr.net/npm/compromise@13.2.0/builds/compromise.browser.min.js"></script>

<style>
  body{font-family:Arial, sans-serif;margin:40px;text-align:center;background:#f5f7fa}
  label,input,button{margin:8px;font-size:15px}
  input[type=number]{width:60px;text-align:center}
  button{padding:9px 18px;border:none;background:#4caf50;color:#fff;cursor:pointer}
  h2{margin-top:32px}
  .question-container{display:inline-block;width:60%;max-width:820px;
      background:#fff;border:1px solid #ddd;padding:12px;margin:14px auto;text-align:left}
  textarea{width:100%;height:70px;margin-top:8px;font-size:14px}
  .feedback{white-space:pre-wrap;background:#e8ffe8;border:1px solid #299d29;
      padding:8px;margin-top:8px;border-radius:4px;font-weight:600}
  .header{font-weight:700;text-decoration:underline;margin:16px 0}
</style>
</head>
<body>
<h1>Resume & JD AI Interview Evaluator</h1>

<!-- File inputs -->
<label>Resume (PDF):</label>
<input type="file" id="resumeFile" accept="application/pdf">
<label>JD (PDF/TXT):</label>
<input type="file" id="jdFile" accept="application/pdf,text/plain"><br>

<!-- Question count controls -->
<label>Technical:</label><input type="number" id="techQty" value="4" min="0" max="10">
<label>Behavioral:</label><input type="number" id="behQty" value="3"  min="0" max="10">
<label>Situational:</label><input type="number" id="sitQty" value="2" min="0" max="10"><br>

<button id="uploadBtn">Upload & Generate Questions</button>

<h2>Generated Questions</h2>
<div id="questionsContainer">Upload files then click “Generate Questions”.</div>
<button id="evaluateBtn">Evaluate Answers</button>

<script>
/* ---------- Heuristic helpers ---------- */
const fillerWords=["um","uh","like","you know","basically","actually","literally","so"];
function countFiller(t){const lc=t.toLowerCase();return fillerWords.reduce((c,w)=>c+(lc.match(new RegExp(`\\b${w}\\b`,"g"))||[]).length,0);}
function avgSentenceLen(t){const s=t.split(/[.!?]\s/).filter(x=>x.trim().length);const w=t.split(/\s+/).length||1;return (w/s.length).toFixed(1);}
function repetition(t){const w=t.toLowerCase().split(/\s+/);const seen={},dups=new Set();w.forEach(x=>{seen[x]?dups.add(x):seen[x]=1});return Array.from(dups).slice(0,5);}

/* ---------- File extraction ---------- */
async function extractText(file){
  console.log("[Extract] start:",file.name);
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=async e=>{
      try{
        if(file.type==="application/pdf"){
          const pdf=await pdfjsLib.getDocument({data:new Uint8Array(e.target.result)}).promise;
          let txt="";for(let p=1;p<=pdf.numPages;p++){
            const pg=await pdf.getPage(p);
            const c=await pg.getTextContent();
            txt+=c.items.map(i=>i.str).join(" ")+" ";
          }
          res(txt.slice(0,3000));
        }else res(e.target.result.slice(0,3000));
      }catch(err){rej(err);}
    };
    file.type==="application/pdf"?r.readAsArrayBuffer(file):r.readAsText(file);
  });
}

/* ---------- Proxy fetch ---------- */
async function callProxy(prompt){
  console.log("%c[LLM PROMPT]","color:blue",prompt);
  const r=await fetch("http://localhost:3000/api/generateContent",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({prompt})
  });
  const d=await r.json();
  console.log("%c[LLM RESPONSE]","color:green",d);
  return d.candidates?.[0]?.content?.parts?.[0]?.text||"";
}

/* ---------- Question generation ---------- */
document.getElementById("uploadBtn").onclick=async()=>{
  const resF=document.getElementById("resumeFile").files[0];
  const jdF =document.getElementById("jdFile").files[0];
  if(!resF||!jdF){alert("Upload both files");return;}

  const techCnt=+document.getElementById("techQty").value||0;
  const behCnt =+document.getElementById("behQty").value||0;
  const sitCnt =+document.getElementById("sitQty").value||0;

  const qc=document.getElementById("questionsContainer");
  qc.innerText="Extracting text…";
  try{
    const resTxt=await extractText(resF);
    const jdTxt =await extractText(jdF);

    qc.innerText="Generating questions…";
    const prompt=`Generate interview questions for the resume and JD below.

Return exactly:
- ${techCnt} Technical questions
- ${behCnt} Behavioral questions
- ${sitCnt} Situational questions

Format strictly:
### Technical Questions
1. ...
### Behavioral Questions
1. ...
### Situational Questions
1. ...

Resume:
${resTxt}

Job Description:
${jdTxt}`;

    const raw=await callProxy(prompt);
    renderQuestions(raw);
  }catch(e){
    console.error(e);
    qc.innerText="Error (see console)";
  }
};

/* ---------- Render questions ---------- */
function parseBlocks(raw){
  const lines=raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const blocks=[];let cur=null;
  lines.forEach(l=>{
    if(l.startsWith("###")){
      cur={head:l.replace(/^###\s*/,""),qs:[]};blocks.push(cur);
    }else{
      if(!cur){cur={head:"Questions",qs:[]};blocks.push(cur);}
      cur.qs.push(l.replace(/^\d+[.)]\s*/,""));
    }
  });
  return blocks;
}
function renderQuestions(raw){
  const blocks=parseBlocks(raw);
  const C=document.getElementById("questionsContainer");
  C.innerHTML="";
  let idx=1;
  blocks.forEach(b=>{
    const h=document.createElement("div");
    h.className="header";h.textContent=b.head;C.appendChild(h);
    b.qs.forEach(q=>{
      const d=document.createElement("div");
      d.className="question-container";
      d.innerHTML=`<p><strong>Q${idx}:</strong> ${q}</p>
        <textarea id="answer${idx}" placeholder="Type your answer…"></textarea>
        <p class="feedback" id="fb${idx}"></p>`;
      C.appendChild(d);idx++;
    });
  });
  window.totalQ=idx-1;
}

/* ---------- Evaluation ---------- */
document.getElementById("evaluateBtn").onclick=async()=>{
  const n=window.totalQ||0;if(!n){alert("No questions yet");return;}
  for(let i=1;i<=n;i++){
    const ta=document.getElementById(`answer${i}`);if(!ta)continue;
    const ans=ta.value.trim();if(!ans)continue;
    const q=ta.parentElement.querySelector("p").innerText;

    const heur=`Filler:${countFiller(ans)} | AvgLen:${avgSentenceLen(ans)} | Repeats:${repetition(ans).join(",")}`;
    const prompt=`You are an interview grader.\nQuestion: ${q}\nAnswer: ${ans}\nHeuristics: ${heur}\nEvaluate on STAR, Bloom (0–5), CEFR clarity, Domain knowledge. Give concise feedback.`;
    document.getElementById(`fb${i}`).innerText="Evaluating…";
    try{
      const fb=await callProxy(prompt);
      document.getElementById(`fb${i}`).innerText=fb||"No feedback";
    }catch(e){
      console.error(e);
      document.getElementById(`fb${i}`).innerText="Error (see console)";
    }
  }
};
</script>
</body>
</html>
